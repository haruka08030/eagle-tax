# Eagle Tax - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

## ğŸ—ï¸ ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Flutter Web App                          â”‚
â”‚                  (ãƒ–ãƒ©ã‚¦ã‚¶ã§å®Ÿè¡Œ)                             â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚   UI Layer   â”‚         â”‚  State Mgmt  â”‚                  â”‚
â”‚  â”‚  (Widgets)   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤   (State)    â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚         â”‚                         â”‚                          â”‚
â”‚         â”‚                         â–¼                          â”‚
â”‚         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Supabase Client  â”‚                 â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ HTTPS
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Supabase Cloud                         â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Edge Functions                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   â”‚
â”‚  â”‚  â”‚  fetch-shopify-orders                      â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  - CORSå¯¾å¿œ                                â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  - ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†                         â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  - ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†                     â”‚      â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                               â”‚
â”‚                              â”‚ Shopify API Call              â”‚
â”‚                              â–¼                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           PostgreSQL Database                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   â”‚
â”‚  â”‚  â”‚  states ãƒ†ãƒ¼ãƒ–ãƒ«                           â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  - code (å·ã‚³ãƒ¼ãƒ‰)                         â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  - name (å·å)                             â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  - sales_threshold (å£²ä¸ŠåŸºæº–)              â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  - txn_threshold (å–å¼•æ•°åŸºæº–)              â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  - logic_type (åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯)               â”‚      â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ HTTPS (Admin API)
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Shopify Store                            â”‚
â”‚                  (eagle-tax-dev-01)                         â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Orders Data                             â”‚   â”‚
â”‚  â”‚  - created_at (æ³¨æ–‡æ—¥æ™‚)                             â”‚   â”‚
â”‚  â”‚  - total_price (å£²ä¸Šé¡)                              â”‚   â”‚
â”‚  â”‚  - shipping_address (é…é€å…ˆä½æ‰€)                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### 1. ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚

```
Flutter App
  â”‚
  â”œâ”€â–º SupabaseåˆæœŸåŒ–
  â”‚     â””â”€â–º SUPABASE_URL, SUPABASE_ANON_KEY
  â”‚
  â””â”€â–º å·ãƒ‡ãƒ¼ã‚¿å–å¾—
        â””â”€â–º SELECT * FROM states
              â””â”€â–º 51å·ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
```

### 2. ãƒªã‚¹ã‚¯è¨ºæ–­å®Ÿè¡Œæ™‚

```
Flutter App
  â”‚
  â”œâ”€â–º æœŸé–“è¨ˆç®— (ç›´è¿‘12ãƒ¶æœˆ)
  â”‚
  â”œâ”€â–º Edge Functionå‘¼ã³å‡ºã— (ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³)
  â”‚     â”‚
  â”‚     â”œâ”€â–º Page 1: fetch-shopify-orders
  â”‚     â”‚     â””â”€â–º Shopify API: GET /orders.json?limit=250
  â”‚     â”‚           â””â”€â–º 250ä»¶ã®æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ + Link header
  â”‚     â”‚
  â”‚     â”œâ”€â–º Page 2: fetch-shopify-orders
  â”‚     â”‚     â””â”€â–º Shopify API: GET /orders.json?page_info=xxx
  â”‚     â”‚           â””â”€â–º 250ä»¶ã®æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ + Link header
  â”‚     â”‚
  â”‚     â””â”€â–º Page N: fetch-shopify-orders
  â”‚           â””â”€â–º Shopify API: GET /orders.json?page_info=yyy
  â”‚                 â””â”€â–º æ®‹ã‚Šã®æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿
  â”‚
  â”œâ”€â–º æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  â”‚     â””â”€â–º created_at < 12ãƒ¶æœˆå‰ â†’ é™¤å¤–
  â”‚
  â”œâ”€â–º å·ã”ã¨ã«é›†è¨ˆ
  â”‚     â”œâ”€â–º å£²ä¸Šé¡ã®åˆè¨ˆ
  â”‚     â””â”€â–º å–å¼•å›æ•°ã®ã‚«ã‚¦ãƒ³ãƒˆ
  â”‚
  â”œâ”€â–º Nexusåˆ¤å®š
  â”‚     â””â”€â–º StateThreshold.checkNexus()
  â”‚           â”œâ”€â–º SALES_ONLY: å£²ä¸Š >= åŸºæº–å€¤
  â”‚           â”œâ”€â–º OR: å£²ä¸Š >= åŸºæº–å€¤ || å–å¼•æ•° >= åŸºæº–å€¤
  â”‚           â”œâ”€â–º AND: å£²ä¸Š >= åŸºæº–å€¤ && å–å¼•æ•° >= åŸºæº–å€¤
  â”‚           â””â”€â–º NONE: false (å…ç¨å·)
  â”‚
  â””â”€â–º çµæœè¡¨ç¤º
        â”œâ”€â–º å±é™ºãªå· (NEXUS REACHED)
        â””â”€â–º å®‰å…¨ãªå· (Safe)
```

---

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### èªè¨¼æƒ…å ±ã®ç®¡ç†

| æƒ…å ± | ä¿å­˜å ´æ‰€ | ç”¨é€” |
|------|----------|------|
| `SUPABASE_URL` | `.env` (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ) | Supabaseã¸ã®æ¥ç¶š |
| `SUPABASE_ANON_KEY` | `.env` (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ) | Supabaseèªè¨¼ |
| `SHOPIFY_SHOP_NAME` | `.env` (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ) | Edge Functionã¸æ¸¡ã™ |
| `SHOPIFY_ACCESS_TOKEN` | `.env` (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ) | Edge Functionã¸æ¸¡ã™ |

**æ³¨æ„**: å°†æ¥çš„ã«ã¯ã€Shopifyèªè¨¼æƒ…å ±ã‚’Supabaseã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã«ç§»è¡Œã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‹ã‚‰å®Œå…¨ã«å‰Šé™¤ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

### ãƒ‡ãƒ¼ã‚¿ã®æµã‚Œ

```
ãƒ–ãƒ©ã‚¦ã‚¶
  â”‚ (HTTPS)
  â”œâ”€â–º Supabase Edge Function
  â”‚     â”‚ (ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰)
  â”‚     â””â”€â–º Shopify Admin API
  â”‚           â””â”€â–º æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿
  â”‚
  â””â”€â–º Supabase PostgreSQL
        â””â”€â–º å·ãƒ‡ãƒ¼ã‚¿
```

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### å˜ä½“ãƒ†ã‚¹ãƒˆ

```dart
// StateThreshold.checkNexus() ã®ãƒ†ã‚¹ãƒˆ
test('SALES_ONLY logic', () {
  final threshold = StateThreshold(
    code: 'CA',
    name: 'California',
    salesThreshold: 500000,
    txnThreshold: null,
    logicType: 'SALES_ONLY',
  );
  
  expect(threshold.checkNexus(
    totalSales: 600000,
    transactionCount: 50,
  ), true);
});
```

### çµ±åˆãƒ†ã‚¹ãƒˆ

```dart
// Edge Functionã®çµ±åˆãƒ†ã‚¹ãƒˆ
testWidgets('Fetch orders from Edge Function', (tester) async {
  final response = await supabase.functions.invoke(
    'fetch-shopify-orders',
    body: {
      'shopName': 'test-shop',
      'accessToken': 'test-token',
    },
  );
  
  expect(response.status, 200);
  expect(response.data['orders'], isNotEmpty);
});
```

---

## ğŸ”§ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

### ãƒ­ã‚°ç›£è¦–

```bash
# Edge Functionã®ãƒ­ã‚°ã‚’ç¢ºèª
supabase functions logs fetch-shopify-orders --follow

# ã‚¨ãƒ©ãƒ¼ã®ã¿è¡¨ç¤º
supabase functions logs fetch-shopify-orders --filter error
```